<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AI-Cards â€“ Error Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ¤–</text></svg>">
  <style>
	:root {
	  --bg: #093271;        /* GitHub dark-blue */
	  --surface: #161b22;
	  --border: #30363d;
      --text: #eee;
      --subtle: #888;
      --accent: #0a84ff;
      --ok: #22c55e;
      --warn: #f59e0b;
      --error: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    /* ---------- TOP BAR ---------- */
    header {
      display: flex;
      align-items: center;
      padding: 0.6rem 1rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      gap: 1rem;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 1.1rem;
    }
    nav {
      display: flex;
      gap: 1rem;
      margin-left: auto;
    }
    nav a {
      color: var(--text);
      text-decoration: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
    }
    nav a:hover {
      background: #ffffff18;
    }
    nav a.active {
      background: var(--accent);
      color: #fff;
    }

    /* ---------- LAYOUT ---------- */
    .layout {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    aside {
      width: 240px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    main {
      flex: 1;
      overflow: auto;
      padding: 1rem;
    }

    /* ---------- SIDEBAR ---------- */
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .filter-group label {
      font-size: 0.75rem;
      color: var(--subtle);
      text-transform: uppercase;
    }
    .filter-group button {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
    }
    .filter-group button:hover {
      border-color: var(--accent);
    }

    /* ---------- TABLE ---------- */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    th, td {
      padding: 0.5rem 0.6rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th {
      position: sticky;
      top: 0;
      background: var(--surface);
    }
    tr:hover { background: #252525; }
    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.warn  { background: var(--warn);  color: #000; }
    .badge.error { background: var(--error); color: #fff; }
    .badge.info  { background: var(--accent); color: #fff; }
    .chip {
      background: #333;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-size: 0.75rem;
    }
    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--subtle);
    }

    /* ---------- ACTION BAR ---------- */
    .actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    input[type="text"] {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      border-radius: 4px;
    }
    button {
      padding: 0.5rem 0.9rem;
      border: none;
      border-radius: 4px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-size: 0.875rem;
    }
    button:hover { filter: brightness(1.15); }
    button.danger { background: var(--error); }
  </style>
</head>
<body>
  <!-- ================= TOP BAR ================= -->
  <header>
    <div class="brand">
      <span style="font-size:1.6rem;">ðŸ¤–</span>
      <span>AI-Cards</span>
    </div>
    <nav>
      <a href="/">Canvas</a>
      <a href="/errors.html" class="active">Errors</a>
    </nav>
  </header>

  <!-- ================= LAYOUT ================= -->
  <div class="layout">
    <!-- ~~~~~~~~~~~~~~ SIDEBAR ~~~~~~~~~~~~~~ -->
    <aside>
      <div class="filter-group">
        <label>Quick filters</label>
        <button onclick="filterLevel('error')">Errors only</button>
        <button onclick="filterLevel('warn')">Warnings only</button>
        <button onclick="filterLevel('')">Show all</button>
      </div>
      <div class="filter-group">
        <label>Actions</label>
        <button onclick="downloadCSV()">â¬‡ Download CSV</button>
        <button class="danger" onclick="clearLog()">ðŸ—‘ Clear log</button>
      </div>
    </aside>

    <!-- ~~~~~~~~~~~~~~ MAIN PANE ~~~~~~~~~~~~~~ -->
    <main>
      <div class="actions">
        <input id="search" type="text" placeholder="Search anythingâ€¦" autocomplete="off">
      </div>

      <table id="table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Level</th>
            <th>Type</th>
            <th>Card</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="no-data" class="no-data">No errors logged yet â€“ great job!</div>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let rows = [];

    /* ---------- 1.  INITIAL LOAD ---------- */
    fetch('/api/errors').then(r => r.json()).then(data => { rows = data.reverse(); render(); });

    /* ---------- 2.  REAL-TIME ---------- */
    socket.on('error', obj => { rows.unshift(obj); render(); });

    /* ---------- 3.  RENDER + FILTER ---------- */
    const tbody   = document.getElementById('tbody');
    const noData  = document.getElementById('no-data');
    const search  = document.getElementById('search');
    let levelFilter = '';

    function render() {
      const q = search.value.trim().toLowerCase();
      const filtered = rows.filter(r => {
        const matchSearch = !q || Object.values(r).some(v => String(v).toLowerCase().includes(q));
        const matchLevel  = !levelFilter || r.level === levelFilter;
        return matchSearch && matchLevel;
      });

      tbody.innerHTML = '';
      if (filtered.length === 0) {
        noData.style.display = 'block';
        return;
      }
      noData.style.display = 'none';
      filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.ts).toLocaleString()}</td>
          <td><span class="badge ${r.level}">${r.level}</span></td>
          <td>${r.type}</td>
          <td><span class="chip">${r.instanceId || '-'}</span></td>
          <td title="${r.message}">${r.message.length > 120 ? r.message.slice(0, 120) + 'â€¦' : r.message}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    search.oninput = render;

    function filterLevel(lvl) { levelFilter = lvl; render(); }

    /* ---------- 4.  DOWNLOAD ---------- */
    function downloadCSV() {
      const header = 'Time,Level,Type,Card,Message\n';
      const csv = header + rows.map(r =>
        `"${r.ts}","${r.level}","${r.type}","${r.instanceId || ''}","${r.message.replace(/"/g, '""')}"`
      ).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'ai-cards-errors.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    /* ---------- 5.  CLEAR ---------- */
    async function clearLog() {
      if (!confirm('Delete all logged errors?')) return;
      await fetch('/api/errors', { method: 'DELETE' });
      rows = []; render();
    }
  </script>
</body>
</html>